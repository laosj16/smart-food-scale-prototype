<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手冲模式 2 - 智能食物秤 Pro</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding-bottom: 80px; }
        .device-screen { width: 100%; max-width: 480px; aspect-ratio: 4 / 3; background-color: #1a1a1a; color: #e0e0e0; border-radius: 0.5rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* Status Bar */
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background-color: rgba(0, 0, 0, 0.2); flex-shrink: 0; height: 36px; position: relative; }
        .status-bar i { font-size: 18px; color: #e0e0e0; line-height: 1; }
        #status-prompt { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 15px; color: #a0a0a0; white-space: nowrap; max-width: calc(100% - 80px); overflow: hidden; text-overflow: ellipsis; }

        /* Main Content Area - Default to center */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Default to center */
            align-items: center;
            padding: 15px;
            position: relative;
            width: 100%; /* Ensure it takes full width */
        }
        /* Modifier class to align content lower */
        .main-content.align-end {
            justify-content: flex-end;
            padding-bottom: 30px;
        }


        /* Ratio Setting Display */
        .ratio-setting-display { display: flex; align-items: baseline; justify-content: center; width: 100%; }
        .ratio-prefix { font-size: 60px; font-weight: 500; color: #a0a0a0; margin-right: 10px;}
        .ratio-value-editable { font-size: 100px; font-weight: 700; color: #ffffff; border: none; background: none; min-width: 100px; text-align: center; outline: none; padding: 0 5px; border-bottom: 2px solid #007AFF; line-height: 1; }

        /* Container for primary display elements */
        .primary-display-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            width: 100%; 
            flex: 1;
            margin: 0;
        }
        /* Main Display Area (Weight/Time/Water/Liquid) */
        .primary-display { 
            width: 100%;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: baseline;
        }
        .primary-value {
            font-size: 110px;
            font-weight: 700;
            line-height: 1;
            color: #ffffff;
            margin-right: 8px;
        }
        .primary-unit {
            font-size: 45px;
            font-weight: 500;
            color: #a0a0a0;
            text-align: left;
            transition: color 0.3s ease;
        }
        .main-content:not(.with-secondary) .primary-value { font-size: 110px; }
        .main-content:not(.with-secondary) .primary-unit { font-size: 45px; display: block; margin-top: 8px; }
        .main-content.with-secondary .primary-value { font-size: 72px; }
        .main-content.with-secondary .primary-unit { font-size: 28px; display: inline-block; margin-top: 0; }
        .unit-g { color: #60a5fa; } .unit-ml { color: #34d399; } .unit-oz { color: #fbbf24; } .unit-lb { color: #f87171; } .unit-lb-oz { color: #c084fc; }

        /* Secondary Display Area */
        .secondary-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            padding: 0 10px;
            margin-bottom: 15px;
            margin-top: -1px; /* 原来是 -15px，增加10px，改为-5px */
        }

        /* 调整信息项的大小和间距 */
        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 8px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            min-height: 70px;
        }

        /* 增加背景色不透明度并确保始终显示 */
        .info-item.bg-ratio { background-color: rgba(52, 152, 219, 0.3) !important; } /* 蓝色 */
        .info-item.bg-time { background-color: rgba(241, 196, 15, 0.3) !important; } /* 黄色 */
        .info-item.bg-flow { background-color: rgba(230, 126, 34, 0.3) !important; } /* 橙色 - 改变流速背景色 */
        .info-item.bg-grounds { background-color: rgba(155, 89, 182, 0.3) !important; } /* 紫色 */
        .info-item.bg-liquid { background-color: rgba(52, 152, 219, 0.3) !important; } /* 蓝色 */
        .info-item.bg-removed { background-color: rgba(192, 57, 43, 0.3) !important; } /* 深红色 */
        .info-item.bg-total-water { background-color: rgba(46, 204, 113, 0.3) !important; } /* 绿色 */

        /* 调整文字大小 */
        .info-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2px; /* 减小标签间距 */
            font-weight: 500;
        }

        .info-value {
            font-size: 24px; /* 调整字号 */
            font-weight: 600;
            color: #ffffff;
            line-height: 1.2; /* 调整行高 */
        }

        .info-unit {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-left: 4px;
            font-weight: 500;
        }

        /* TARE Indicator */
        .tare-indicator { 
            position: absolute; 
            top: 20px; 
            left: 15px; 
            background-color: #007AFF; 
            color: white; 
            padding: 3px 8px; 
            border-radius: 5px; 
            font-size: 14px; 
            font-weight: bold; 
            opacity: 0; 
            pointer-events: none;
            transition: opacity 0.2s ease-out; 
            z-index: 999; 
            display: block !important;
            white-space: nowrap; 
        }
        .tare-indicator.visible { 
            opacity: 1; 
        }

        /* Hide elements by default */
        .hidden { display: none !important; }

        /* Hint Bar / Progress Bar Container */
        .hint-progress-bar-container { width: 100%; height: 36px; background-color: rgba(0, 0, 0, 0.3); flex-shrink: 0; position: relative; overflow: hidden; }
        .hint-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 15px; color: #b0b0b0; z-index: 2; padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .progress-bar-fill { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background-color: #2ecc71; /* 初始为绿色 */ transition: width 0.2s linear, background-color 0.3s ease; z-index: 1; }

        /* Overlays and Progress Ring Styles */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 10; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease; }
        .overlay.visible { opacity: 1; visibility: visible; }
        .progress-ring { position: relative; width: 90px; height: 90px; margin-bottom: 1rem; }
        .progress-ring__circle { transition: 0.1s stroke-dashoffset linear, 0.2s stroke ease; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .progress-ring__svg circle { stroke-width: 6; }
        .progress-ring__svg .progress-ring__circle--background { r: 42; cx: 45; cy: 45; stroke: #555;}
        .progress-ring__svg .progress-ring__circle { r: 42; cx: 45; cy: 45; }
        .progress-ring__text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; }
        #long-press-action-text { font-size: 1.1rem; text-align: center; padding: 0 10px;}
        @keyframes blink-color { 0%, 100% { color: #facc15; } 50% { color: #ffffff; } }
        .blink-text { animation: blink-color 1s infinite; font-weight: bold; }
        #power-off-confirm-overlay .confirm-options { display: flex; gap: 20px; margin-top: 20px; }
        #power-off-confirm-overlay .option { padding: 8px 16px; border: 2px solid #555; border-radius: 6px; cursor: default; transition: background-color 0.2s, border-color 0.2s; }
        #power-off-confirm-overlay .option.selected { background-color: #007AFF; border-color: #0056b3; }

        /* Interaction Controls Styles */
        .interaction-controls { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(240, 240, 240, 0.95); backdrop-filter: blur(5px); padding: 0.75rem 1rem; border-top: 1px solid #ccc; display: flex; justify-content: center; align-items: center; gap: 0.5rem; z-index: 100; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        .control-button { padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 500; background-color: #4f46e5; color: white; border: none; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .control-button:hover { background-color: #4338ca; }
        .control-button:active { transform: scale(0.95); }
        .control-button.secondary { background-color: #64748b; }
        .control-button.secondary:hover { background-color: #475569; }
        .control-button:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }

        .ratio-display {
            transition: color 0.3s ease;
        }
        .ratio-display.ratio-white { color: #ffffff; }
        .ratio-display.ratio-green { color: #2ecc71; }
        .ratio-display.ratio-orange { color: #e67e22; }
        .ratio-display.ratio-red { color: #e74c3c; }
    </style>
</head>
<body>

    <div class="device-screen">
        <div class="status-bar">
            <i class="fa-brands fa-bluetooth-b"></i>
            <span id="status-prompt"></span>
            <i class="fa-solid fa-battery-full"></i>
        </div>

        <div id="main-content" class="main-content">
            <div id="tare-indicator" class="tare-indicator">TARE</div>

            <div id="ratio-setting-display" class="ratio-setting-display">
                <span class="ratio-prefix">1 :</span>
                <span id="ratio-value-editable" class="ratio-value-editable">15</span>
            </div>

            <div id="primary-display-container" class="primary-display-container hidden">
                <div id="primary-display" class="primary-display">
                    <span id="primary-value" class="primary-value"></span>
                    <span id="primary-unit" class="primary-unit"></span>
                </div>
            </div>

            <div id="secondary-display" class="secondary-display hidden">
                <div class="info-item bg-total-water">
                    <span class="info-label" id="ratio-label">总注水</span>
                    <span class="info-value">
                        <span id="ratio-value">0.0</span>
                        <span class="info-unit" id="ratio-unit">g</span>
                    </span>
                </div>
                <div class="info-item bg-time">
                    <span class="info-label">时间</span>
                    <span id="timer-value" class="info-value">00:00</span>
                </div>
                <div class="info-item bg-flow">
                    <span class="info-label" id="bottom-left-label">流速</span>
                    <span class="info-value">
                        <span id="bottom-left-value">0.0</span>
                        <span class="info-unit" id="bottom-left-unit">g/s</span>
                    </span>
                </div>
                <div class="info-item bg-grounds">
                    <span class="info-label" id="bottom-right-label">粉重</span>
                    <span class="info-value">
                        <span id="bottom-right-value">0.0</span>
                        <span class="info-unit" id="bottom-right-unit">g</span>
                    </span>
                </div>
            </div>
        </div>

        <div id="hint-progress-bar-container" class="hint-progress-bar-container">
            <div id="progress-bar-fill" class="progress-bar-fill"></div>
            <div id="hint-text" class="hint-text"></div> </div>


        <div id="long-press-overlay" class="overlay">
             <div class="progress-ring"> <svg class="progress-ring__svg" width="90" height="90"> <circle class="progress-ring__circle progress-ring__circle--background" fill="transparent" r="42" cx="45" cy="45"/> <circle id="progress-circle" class="progress-ring__circle" stroke="#007AFF" stroke-linecap="round" fill="transparent" r="42" cx="45" cy="45"/> </svg> <span id="progress-text" class="progress-ring__text"></span> </div>
            <p id="long-press-action-text" class="mt-1 text-lg"></p>
        </div>
        <div id="power-off-confirm-overlay" class="overlay">
            <p class="text-xl mb-4">确认关机?</p>
            <div class="confirm-options"> <span id="confirm-cancel" class="option selected">取消</span> <span id="confirm-power-off" class="option">确认</span> </div>
            <p class="text-sm mt-4 text-gray-400">旋转选择, 短按确认 (3秒后自动取消)</p>
        </div>
    </div>

    <div class="interaction-controls">
        <button id="btn-rotate-left" class="control-button" title="模拟向左旋转">← 旋转</button>
        <button id="btn-rotate-right" class="control-button" title="模拟向右旋转">旋转 →</button>
        <button id="btn-short-press" class="control-button" title="模拟短按">确认比例</button>
        <button id="btn-long-press" class="control-button secondary" title="模拟长按旋钮">长按 (返回/关机)</button>
        <button id="btn-return-index" class="control-button secondary" title="返回目录页面">返回目录</button>
        <button id="btn-simulate-place" class="control-button" style="background-color: #10b981;" disabled>模拟放置</button>
        <button id="btn-simulate-remove" class="control-button" style="background-color: #f87171;" disabled>模拟拿走</button>
    </div>

    <script>
        // --- State Variables ---
        const State = { SETTING_RATIO: 'SETTING_RATIO', WAITING_GEAR_TARE: 'WAITING_GEAR_TARE', WAITING_GROUNDS: 'WAITING_GROUNDS', WEIGHING_GROUNDS: 'WEIGHING_GROUNDS', READY_TO_POUR: 'READY_TO_POUR', POURING: 'POURING', FINISHED: 'FINISHED', WEIGHING_LIQUID: 'WEIGHING_LIQUID' };
        let currentState = State.SETTING_RATIO;
        const radius = 42;
        const circumference = radius * 2 * Math.PI;
        let targetRatio = 15; let currentWeight = 0.0; let gearWeight = 0.0;
        let coffeeGroundsWeight = 15.7; let measuredGroundsWeight = 0.0;
        let totalWaterWeight = 0.0; let coffeeLiquidWeight = 0.0; let removedWeight = 0.0;
        let timerInterval = null; let timerSeconds = 0; let pouringInterval = null;
        let lastWaterAddTime = 0; let lastWaterWeight = 0; let currentFlowRateGramsPerSecond = 0.0;
        let calculatedTargetWaterWeight = 0.0;

        // 长按和电源确认相关变量
        let longPressTimer = null;
        let longPressStartTime = 0;
        let currentLongPressDuration = 0;
        let longPressActive = false;
        let longPressThresholdMet = false;
        let isPowerConfirmActive = false;
        let powerConfirmSelection = 'cancel';
        let powerConfirmTimeout = null;

        const SHOW_OVERLAY_DURATION = 1000;
        const POWER_CONFIRM_DURATION = 5000;
        const POWER_CONFIRM_TIMEOUT_DURATION = 3000;
        const LONG_PRESS_COLOR_BACK = '#007AFF';

        // 单位相关变量
        const units = ['g', 'ml', 'fl:oz', 'oz', 'lb'];
        const unitColors = { 
            'g': 'unit-g', 
            'ml': 'unit-ml', 
            'fl:oz': 'unit-oz',
            'oz': 'unit-oz', 
            'lb': 'unit-lb' 
        };
        let currentUnitIndex = 0; let tareTimeout = null;

        // 单位转换常量
        const G_PER_ML = 1.0;
        const G_PER_OZ = 28.3495;
        const G_PER_LB = 453.592;
        const ML_PER_FL_OZ = 29.5735;

        function getDecimalPlaces(weight, unit) {
            // 根据不同单位和重量范围返回应显示的小数位数
            if (unit === 'g' || unit === 'ml') {
                if (weight < 500) return 1;        // 0.3-500g: ±0.5g
                if (weight <= 1000) return 0;      // 500.1-1000g: ±1g
                if (weight <= 2000) return 0;      // 1000.1-2000g: ±2g
                if (weight <= 3000) return 0;      // 2000.5-3000g: ±3g
                if (weight <= 4000) return 0;      // 3000.5-4000g: ±4g
                return 0;                          // 4000.5-5000g: ±5g
            } else if (unit === 'oz') {
                if (weight < 17.64) return 2;      // ~500g
                if (weight < 35.27) return 1;      // ~1000g
                return 0;
            } else if (unit === 'fl:oz') {
                if (weight < 16.91) return 2;      // ~500ml
                if (weight < 33.81) return 1;      // ~1000ml
                return 0;
            } else if (unit === 'lb') {
                if (weight < 1.1) return 3;        // ~500g
                if (weight < 2.2) return 2;        // ~1000g
                if (weight < 4.4) return 2;        // ~2000g
                return 1;
            }
            return 1; // 默认返回1位小数
        }

        function formatWeight(weightValue) {
            const currentUnit = units[currentUnitIndex];
            let valueInGrams = weightValue;
            let displayUnit = 'g';
            let valueToDisplay = valueInGrams;

            // 单位转换
            if (currentUnit === 'ml') {
                valueToDisplay = valueInGrams / G_PER_ML;
                displayUnit = 'ml';
            } else if (currentUnit === 'oz') {
                valueToDisplay = valueInGrams / G_PER_OZ;
                displayUnit = 'oz';
            } else if (currentUnit === 'fl:oz') {
                valueToDisplay = valueInGrams / ML_PER_FL_OZ;
                displayUnit = 'fl:oz';
            } else if (currentUnit === 'lb') {
                valueToDisplay = valueInGrams / G_PER_LB;
                displayUnit = 'lb';
            }

            // 根据重量范围确定小数位数
            const decimalPlaces = getDecimalPlaces(valueToDisplay, currentUnit);
            
            // 处理接近零的情况
            let displayWeight;
            if (Math.abs(valueToDisplay) < 0.3 && (currentUnit === 'g' || currentUnit === 'ml')) {
                displayWeight = '0.0';
            } else {
                displayWeight = valueToDisplay.toFixed(decimalPlaces);
            }

            return { value: displayWeight, unit: displayUnit };
        }

        // --- DOM Elements (Declare inside load event) ---
        let mainContent, statusPrompt, ratioSettingDisplay, ratioValueEditable,
            primaryDisplayContainer, primaryDisplay, primaryValue, primaryUnit,
            secondaryDisplay, ratioLabel, ratioValue, timerValue,
            bottomLeftLabel, bottomLeftValue, bottomLeftUnit,
            bottomRightLabel, bottomRightValue, bottomRightUnit,
            hintBarContainer, hintText, progressBarFill, tareIndicator,
            ratioInfoItem, timeInfoItem, bottomLeftInfoItem, bottomRightInfoItem,
            longPressOverlay, progressCircle, progressText, longPressActionText,
            powerOffConfirmOverlay, confirmCancelBtn, confirmPowerOffBtn,
            btnRotateLeft, btnRotateRight, btnShortPress, btnLongPress,
            btnReturnIndex, btnSimulatePlace, btnSimulateRemove;

        // --- Functions ---

        function formatTime(seconds) { /* ... (same) ... */
             const mins = Math.floor(seconds / 60); const secs = seconds % 60; return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        function startTimer() { /* ... (same) ... */
              if (timerInterval) return; timerSeconds = 0; lastWaterAddTime = Date.now(); lastWaterWeight = 0.0; currentFlowRateGramsPerSecond = 0.0; timerValue.textContent = formatTime(timerSeconds); timerInterval = setInterval(() => { timerSeconds++; if (timerSeconds >= 600) { stopTimer(); timerSeconds = 599; } timerValue.textContent = formatTime(timerSeconds); if (currentState === State.POURING && !pouringInterval) { calculateFlowRate(0); } }, 1000);
        }
        function stopTimer() { /* ... (same) ... */
              if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } if (pouringInterval) { clearInterval(pouringInterval); pouringInterval = null; } currentFlowRateGramsPerSecond = 0.0;
        }
         function resetScale() { /* ... (same) ... */
              stopTimer(); timerSeconds = 0; currentWeight = 0.0; gearWeight = 0.0; measuredGroundsWeight = 0.0; coffeeGroundsWeight = 15.7; totalWaterWeight = 0.0; coffeeLiquidWeight = 0.0; removedWeight = 0.0; currentUnitIndex = 0; currentFlowRateGramsPerSecond = 0.0; targetRatio = 15; calculatedTargetWaterWeight = 0.0; setState(State.SETTING_RATIO);
        }
        function showTareIndicator() {
            if (!tareIndicator) return;
            console.log('Showing TARE indicator');
            tareIndicator.classList.add('visible');
            if (tareTimeout) { clearTimeout(tareTimeout); }
            tareTimeout = setTimeout(() => {
                console.log('Hiding TARE indicator');
                tareIndicator.classList.remove('visible');
                tareTimeout = null;
            }, 1000);
        }
        function calculateFlowRate(addedWaterGrams) { /* ... (same) ... */
               const now = Date.now(); const timeDiff = (now - lastWaterAddTime) / 1000; if (timeDiff > 0.1) { currentFlowRateGramsPerSecond = addedWaterGrams / timeDiff; lastWaterAddTime = now; lastWaterWeight = totalWaterWeight; } else if (addedWaterGrams === 0 && timeDiff > 0.5) { currentFlowRateGramsPerSecond = 0.0; } if (secondaryDisplay && !secondaryDisplay.classList.contains('hidden')) { bottomLeftValue.textContent = formatFlowRate(currentFlowRateGramsPerSecond).value; bottomLeftUnit.textContent = formatFlowRate(currentFlowRateGramsPerSecond).unit; }
        }
        function formatFlowRate(rateGramsPerSecond) { /* ... (same) ... */
             const currentUnit = units[currentUnitIndex]; let displayRate; let displayUnitSuffix = '/s'; if (currentUnit === 'ml') { displayRate = (rateGramsPerSecond / G_PER_ML).toFixed(1); displayUnitSuffix = 'ml/s'; } else if (currentUnit === 'oz' || currentUnit === 'lb:oz') { displayRate = (rateGramsPerSecond / G_PER_OZ).toFixed(1); displayUnitSuffix = 'oz/s'; } else if (currentUnit === 'lb') { displayRate = (rateGramsPerSecond / G_PER_LB).toFixed(2); displayUnitSuffix = 'lb/s'; } else { displayRate = rateGramsPerSecond.toFixed(1); displayUnitSuffix = 'g/s'; } if (Math.abs(parseFloat(displayRate)) < 0.01) { displayRate = (0.0).toFixed(displayRate.includes('.') ? displayRate.split('.')[1].length : 1); } return { value: displayRate, unit: displayUnitSuffix };
        }


        // Update UI based on current state (Revised V14)
        function updateUI() {
            // Ensure elements are available (important due to DOM loading)
            if (!mainContent || !statusPrompt || !ratioSettingDisplay || !primaryDisplayContainer || !hintText) {
                console.error("DOM elements not ready for updateUI");
                return;
            }

            const currentUnit = units[currentUnitIndex];
            let promptText = ''; let hintTextVal = '';
            let shortPressAction = '';
            let showRatioSetting = false; let showWeightPrimaryLarge = false;
            let showWaterPrimary = false; let showLiquidPrimary = false;
            let showSecondary = false; let enableRotation = false;
            let shortPressEnabled = true; let centerContentVertically = true;
            let showProgressBar = false;

            // Determine flags based on state
            switch (currentState) {
                case State.SETTING_RATIO:
                    showRatioSetting = true; enableRotation = true;
                    centerContentVertically = true;
                    promptText = "请设置粉和水的比例 (1:X)";
                    hintTextVal = "旋转调整, 短按确认";
                    shortPressAction = '确认比例';
                    break;
                case State.WAITING_GEAR_TARE:
                    showWeightPrimaryLarge = true; enableRotation = true;
                    centerContentVertically = false;
                    promptText = "请放置量杯、滤杯和滤纸";
                    hintTextVal = "放置后, 短按TARE去皮";
                    shortPressAction = 'TARE';
                    break;
                case State.WAITING_GROUNDS:
                    showWeightPrimaryLarge = true; enableRotation = true;
                    centerContentVertically = false;
                    promptText = "好的，现在请加入咖啡粉";
                    hintTextVal = "等待加入...";
                    shortPressAction = 'TARE';
                    break;
                case State.WEIGHING_GROUNDS:
                    showWeightPrimaryLarge = true; enableRotation = true;
                    centerContentVertically = false;
                    promptText = "好的，现在请加入咖啡粉";
                    hintTextVal = "旋转切换单位, 短按TARE去皮";
                    shortPressAction = 'TARE';
                    break;
                case State.READY_TO_POUR:
                    promptText = "请开始注水...";
                    showWaterPrimary = true;
                    showSecondary = true;
                    enableRotation = false;
                    showProgressBar = true;
                    centerContentVertically = true;
                    shortPressAction = '---';
                    break;
                case State.POURING:
                case State.FINISHED:
                    showWaterPrimary = true;
                    showSecondary = true;
                    enableRotation = false;
                    showProgressBar = true;
                    centerContentVertically = true;
                    promptText = currentState === State.POURING ? "请开始注水..." : "冲煮完成";
                    shortPressAction = currentState === State.POURING ? '停止' : '复位';
                    break;
                case State.WEIGHING_LIQUID:
                    showLiquidPrimary = true; showSecondary = true; enableRotation = false;
                    showProgressBar = false; centerContentVertically = true;
                    promptText = "计算液重..."; hintTextVal = "短按 TARE 复位"; shortPressAction = '复位';
                    break;
            }

            // Show/Hide Major UI Blocks & Adjust Alignment
            mainContent.classList.toggle('center-content', centerContentVertically);
            mainContent.classList.toggle('align-end', !centerContentVertically);
            ratioSettingDisplay.classList.toggle('hidden', !showRatioSetting);
            primaryDisplayContainer.classList.toggle('hidden', showRatioSetting); // Explicitly show/hide
            secondaryDisplay.classList.toggle('hidden', !showSecondary);

            // Update Opacity/Visibility for Hint/Progress Bar
            hintBarContainer.style.opacity = '1';
            if (progressBarFill) progressBarFill.style.opacity = showProgressBar ? '1' : '0';
            if (hintText) hintText.style.opacity = showProgressBar ? '0' : '1';


             // --- Update Primary Display ---
             if (!showRatioSetting) {
                // 切换主内容区的with-secondary类，决定主显示区排版
                mainContent.classList.toggle('with-secondary', showSecondary);
                if (showWeightPrimaryLarge) {
                    const formatted = formatWeight(currentWeight);
                    primaryValue.textContent = formatted.value;
                    primaryUnit.textContent = formatted.unit;
                    primaryValue.className = 'primary-value'; // 重置为默认类，显示白色
                    primaryUnit.className = 'primary-unit';
                    if (unitColors[formatted.unit]) {
                        primaryUnit.classList.add(unitColors[formatted.unit]);
                    }
                } else if (showWaterPrimary) {
                    // 计算当前粉水比
                    const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight;
                    const currentRatio = grounds > 0 ? totalWaterWeight / grounds : 0;
                    
                    // 设置显示内容为粉水比格式
                    primaryValue.textContent = '1:' + currentRatio.toFixed(1);
                    primaryUnit.textContent = ''; // 清空单位显示
                    
                    // 根据比例接近目标值的程度设置颜色
                    primaryValue.className = 'primary-value ratio-display';
                    const targetPercent = (currentRatio / targetRatio) * 100;
                    
                    if (targetPercent === 0) {
                        primaryValue.classList.add('ratio-white');
                    } else if (targetPercent <= 60) {
                        primaryValue.classList.add('ratio-green');
                    } else if (targetPercent <= 80) {
                        primaryValue.classList.add('ratio-orange');
                    } else {
                        primaryValue.classList.add('ratio-red');
                    }
                } else if (showLiquidPrimary) {
                    // 计算粉液比
                    const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight;
                    const liquidRatio = grounds > 0 ? coffeeLiquidWeight / grounds : 0;
                    
                    // 设置显示内容为粉液比格式
                    primaryValue.textContent = '1:' + liquidRatio.toFixed(1);
                    primaryUnit.textContent = ''; // 清空单位显示
                    
                    // 设置颜色样式
                    primaryValue.className = 'primary-value ratio-display';
                    primaryValue.classList.add('ratio-white'); // 使用白色显示粉液比
                }
             }


            // --- Update Secondary Display ---
            if (showSecondary) {
                const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight;
                const totalWaterFormatted = formatWeight(totalWaterWeight);
                const liquidFormatted = formatWeight(coffeeLiquidWeight);
                const removedFormatted = formatWeight(removedWeight);
                const flowRateFormatted = formatFlowRate(currentFlowRateGramsPerSecond);

                // 重置背景色
                ratioInfoItem.className = 'info-item bg-total-water';
                timeInfoItem.className = 'info-item bg-time';
                bottomLeftInfoItem.className = 'info-item';
                bottomRightInfoItem.className = 'info-item';

                if (grounds > 0.1) {
                    if (currentState === State.POURING || currentState === State.READY_TO_POUR || currentState === State.FINISHED) {
                        // 更新总注水显示
                        ratioLabel.textContent = "总注水";
                        ratioValue.textContent = totalWaterFormatted.value;
                        if (ratioUnit) ratioUnit.textContent = totalWaterFormatted.unit;
                        
                        timerValue.textContent = formatTime(timerSeconds);
                        bottomLeftLabel.textContent = "流速";
                        bottomLeftValue.textContent = flowRateFormatted.value;
                        bottomLeftUnit.textContent = flowRateFormatted.unit;
                        bottomRightLabel.textContent = "粉重";
                        bottomRightValue.textContent = grounds.toFixed(1);
                        bottomRightUnit.textContent = 'g';
                        
                        bottomLeftInfoItem.classList.add('bg-flow');
                        bottomRightInfoItem.classList.add('bg-grounds');
                    } else { // WEIGHING_LIQUID
                        ratioLabel.textContent = "总注水";
                        ratioValue.textContent = totalWaterFormatted.value;
                        if (ratioUnit) ratioUnit.textContent = totalWaterFormatted.unit;
                        
                        timerValue.textContent = formatTime(timerSeconds);
                        bottomLeftLabel.textContent = "移走重量";
                        bottomLeftValue.textContent = removedFormatted.value;
                        bottomLeftUnit.textContent = removedFormatted.unit;
                        bottomRightLabel.textContent = "液重";
                        bottomRightValue.textContent = liquidFormatted.value;
                        bottomRightUnit.textContent = liquidFormatted.unit;
                        
                        bottomLeftInfoItem.classList.add('bg-removed');
                        bottomRightInfoItem.classList.add('bg-liquid');
                    }
                } else {
                    ratioLabel.textContent = "总注水";
                    ratioValue.textContent = '0.0';
                    if (ratioUnit) ratioUnit.textContent = 'g';
                    
                    timerValue.textContent = formatTime(timerSeconds);
                    bottomLeftLabel.textContent = "流速";
                    bottomLeftValue.textContent = '0.0';
                    bottomLeftUnit.textContent = "g/s";
                    bottomRightLabel.textContent = "粉重";
                    bottomRightValue.textContent = '0.0';
                    bottomRightUnit.textContent = 'g';
                    
                    bottomLeftInfoItem.classList.add('bg-flow');
                    bottomRightInfoItem.classList.add('bg-grounds');
                }
            }

            // --- Update Progress Bar ---
            if (showProgressBar) { 
                const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight;
                calculatedTargetWaterWeight = grounds * targetRatio;
                let progressPercent = 0;
                
                if (calculatedTargetWaterWeight > 0.1) {
                    progressPercent = Math.min(100, (totalWaterWeight / calculatedTargetWaterWeight) * 100);
                    
                    // 设置进度条宽度
                    progressBarFill.style.width = `${progressPercent}%`;
                    
                    // 使用与粉水比显示相同的颜色逻辑
                    if (progressPercent === 0) {
                        progressBarFill.style.backgroundColor = '#ffffff'; // 白色
                    } else if (progressPercent <= 60) {
                        progressBarFill.style.backgroundColor = '#2ecc71'; // 绿色
                    } else if (progressPercent <= 80) {
                        progressBarFill.style.backgroundColor = '#e67e22'; // 橙色
                    } else {
                        progressBarFill.style.backgroundColor = '#e74c3c'; // 红色
                    }
                }
            } else {
                if(progressBarFill) {
                    progressBarFill.style.width = '0%';
                    progressBarFill.style.backgroundColor = '#ffffff'; // 重置为白色
                }
            }


            // --- Update Prompt, Hint, Buttons ---
            statusPrompt.textContent = promptText;
            if(hintText) hintText.textContent = hintTextVal; // Update hint text content
            btnShortPress.textContent = `${shortPressAction === '---' ? '---' : shortPressAction} (短按)`;
            btnShortPress.disabled = !shortPressEnabled;
            btnRotateLeft.disabled = !enableRotation;
            btnRotateRight.disabled = !enableRotation;
            btnSimulatePlace.disabled = currentState === State.SETTING_RATIO || currentState === State.FINISHED || currentState === State.WEIGHING_LIQUID;
            btnSimulateRemove.disabled = currentState !== State.FINISHED;
        }

        function setState(newState) {
             console.log(`State transition: ${currentState} -> ${newState}`);
             currentState = newState;
             // Ensure elements are ready before calling updateUI
             if (mainContent) {
                 updateUI();
             } else {
                 console.warn("setState called before DOM ready, delaying UI update.");
                 // Optionally, queue the update or rely on the 'load' event handler
             }
        }

        // --- Simulation Logic ---
        function simulatePlacement(weight) { /* ... (same as V11) ... */
               console.log(`Simulating placement: ${weight}g`); if (currentState === State.SETTING_RATIO) return; currentWeight += weight; updateUI(); switch (currentState) { case State.WAITING_GEAR_TARE: break; case State.WAITING_GROUNDS: if (currentWeight > 0.5) { measuredGroundsWeight = currentWeight; console.log(`Grounds added: ${measuredGroundsWeight.toFixed(1)}g. Waiting manual tare.`); setState(State.WEIGHING_GROUNDS); } break; case State.READY_TO_POUR: if (weight > 0.1) { console.log("Water detected, starting timer and pour..."); startTimer(); startPourSimulation(); setState(State.POURING); } break; case State.POURING: console.log("Adding more water during pour..."); startPourSimulation(true); break; }
        }
        function startPourSimulation(isContinuing = false) { /* ... (same as V11) ... */
                if (pouringInterval && !isContinuing) return; if (!isContinuing) { lastWaterWeight = 0.0; lastWaterAddTime = Date.now(); currentWeight = totalWaterWeight; } const pourRate = 4.0; const intervalTime = 200; if (pouringInterval) clearInterval(pouringInterval); pouringInterval = setInterval(() => { const waterToAdd = pourRate; totalWaterWeight += waterToAdd; currentWeight = totalWaterWeight; calculateFlowRate(waterToAdd); if (totalWaterWeight >= calculatedTargetWaterWeight) { totalWaterWeight = calculatedTargetWaterWeight; currentWeight = totalWaterWeight; stopPourSimulation(); console.log("Target water weight reached."); } updateUI(); }, intervalTime);
        }
        function stopPourSimulation() { /* ... (same as V11) ... */
                if (pouringInterval) { clearInterval(pouringInterval); pouringInterval = null; calculateFlowRate(0); updateUI(); }
        }
        function simulateRemoval() { /* ... (same as V11) ... */
                console.log("Simulating removal"); if (currentState === State.FINISHED || currentState === State.WEIGHING_LIQUID) { stopPourSimulation(); stopTimer(); const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight; const retainedWater = grounds * 2; coffeeLiquidWeight = Math.max(0, totalWaterWeight - retainedWater); removedWeight = gearWeight + grounds + retainedWater; /* Use gearWeight */ console.log(`Filter removed. Liquid: ${coffeeLiquidWeight.toFixed(1)}g, Retained: ${retainedWater.toFixed(1)}g, Removed: ${removedWeight.toFixed(1)}g`); setState(State.WEIGHING_LIQUID); } else { console.warn(`Cannot simulate removal in state: ${currentState}`); }
        }

        // --- Button Handlers ---
        function handleShortPress() {
            if (isPowerConfirmActive) {
                clearTimeout(powerConfirmTimeout);
                if (powerConfirmSelection === 'power-off') {
                    simulatePowerOff();
                } else {
                    hidePowerConfirm();
                }
                return;
            }

            console.log(`Short press in state: ${currentState}`);
            switch (currentState) {
                case State.SETTING_RATIO:
                    setState(State.WAITING_GEAR_TARE);
                    break;
                case State.WAITING_GEAR_TARE:
                    showTareIndicator(); // 显示TARE指示器
                    gearWeight = currentWeight; // 保存器具重量
                    currentWeight = 0.0; // 将当前重量归零
                    setState(State.WAITING_GROUNDS);
                    break;
                case State.WEIGHING_GROUNDS:
                    showTareIndicator();
                    coffeeGroundsWeight = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight;
                    currentWeight = 0.0;
                    totalWaterWeight = 0.0;
                    setState(State.READY_TO_POUR);
                    break;
                case State.POURING:
                    stopTimer();
                    stopPourSimulation();
                    setState(State.FINISHED);
                    break;
                case State.WEIGHING_LIQUID:
                case State.FINISHED:
                    resetScale();
                    break;
            }
        }
        function handleRotate(direction) { /* ... (same as V11) ... */
               if (isPowerConfirmActive) { powerConfirmSelection = (powerConfirmSelection === 'cancel') ? 'power-off' : 'cancel'; updatePowerConfirmSelection(); resetPowerConfirmTimeout(); } else if (currentState === State.SETTING_RATIO) { targetRatio += direction; if (targetRatio < 1) targetRatio = 99; if (targetRatio > 99) targetRatio = 1; ratioValueEditable.textContent = targetRatio; } else if (currentState === State.WAITING_GEAR_TARE || currentState === State.WEIGHING_GROUNDS) { currentUnitIndex = (currentUnitIndex + direction + units.length) % units.length; updateUI(); }
        }


        // --- Power Off & Long Press Logic (Copied from general_weighing V10) ---
        function showPowerConfirm() { /* ... */ }
        function hidePowerConfirm() { /* ... */ }
        function updatePowerConfirmSelection() { /* ... */ }
        function resetPowerConfirmTimeout() { /* ... */ }
        function simulatePowerOff() { /* ... */ }
        function disableAllButtons() { /* ... */ }
        // (Copy full functions from general_weighing V10)
        function showPowerConfirm() { isPowerConfirmActive = true; powerConfirmSelection = 'cancel'; updatePowerConfirmSelection(); powerOffConfirmOverlay.classList.add('visible'); if(hintText) hintText.textContent = "旋转选择, 短按确认"; resetPowerConfirmTimeout(); }
        function hidePowerConfirm() { if (powerConfirmTimeout) clearTimeout(powerConfirmTimeout); isPowerConfirmActive = false; powerOffConfirmOverlay.classList.remove('visible'); updateUI(); }
        function updatePowerConfirmSelection() { confirmCancelBtn.classList.toggle('selected', powerConfirmSelection === 'cancel'); confirmPowerOffBtn.classList.toggle('selected', powerConfirmSelection === 'power-off'); }
        function resetPowerConfirmTimeout() { if (powerConfirmTimeout) clearTimeout(powerConfirmTimeout); powerConfirmTimeout = setTimeout(() => { console.log("Power confirm timed out."); hidePowerConfirm(); }, POWER_CONFIRM_TIMEOUT_DURATION); }
        function simulatePowerOff() { console.log("Simulating Power Off..."); powerOffConfirmOverlay.innerHTML = '<p class="text-2xl">关机...</p>'; disableAllButtons(); }
        function disableAllButtons() { [btnRotateLeft, btnRotateRight, btnShortPress, btnLongPress, btnReturnIndex, btnSimulatePlace, btnSimulateRemove].forEach(btn => btn.disabled = true); }
        function setProgress(percent) { if(!progressCircle) return; const offset = circumference - percent / 100 * circumference; progressCircle.style.strokeDashoffset = offset; }
        function startLongPress() { if (longPressActive || isPowerConfirmActive || !longPressOverlay) return; longPressActive = true; longPressThresholdMet = false; longPressStartTime = Date.now(); currentLongPressDuration = 0; longPressOverlay.classList.remove('visible'); setProgress(0); const updateProgress = () => { if (!longPressActive) return; const elapsedTime = Date.now() - longPressStartTime; currentLongPressDuration = elapsedTime; if (!longPressThresholdMet && elapsedTime >= SHOW_OVERLAY_DURATION) { longPressThresholdMet = true; if(progressCircle) progressCircle.setAttribute('stroke', LONG_PRESS_COLOR_BACK); if(longPressActionText) longPressActionText.innerHTML = `此时<span class="blink-text">松开按钮</span>，<strong class="font-bold">返回上一级菜单</strong>`; longPressOverlay.classList.add('visible'); } if (longPressThresholdMet) { const progressPercent = Math.min(100, (elapsedTime / POWER_CONFIRM_DURATION) * 100); setProgress(progressPercent); const remainingSeconds = Math.ceil((POWER_CONFIRM_DURATION - elapsedTime) / 1000); if(progressText) progressText.textContent = remainingSeconds > 0 ? remainingSeconds : '0'; if (elapsedTime >= POWER_CONFIRM_DURATION) { cancelAnimationFrame(longPressTimer); longPressTimer = null; longPressActive = false; longPressOverlay.classList.remove('visible'); showPowerConfirm(); return; } } if (longPressActive) { longPressTimer = requestAnimationFrame(updateProgress); } }; longPressTimer = requestAnimationFrame(updateProgress); }
        function cancelLongPress() {
            if (!longPressActive) return;
            longPressActive = false;
            if (longPressTimer) { cancelAnimationFrame(longPressTimer); longPressTimer = null; }
            if (longPressThresholdMet && longPressOverlay) { longPressOverlay.classList.remove('visible'); }
            if (currentLongPressDuration >= SHOW_OVERLAY_DURATION && currentLongPressDuration < POWER_CONFIRM_DURATION) {
                console.log("Executing Back Action (Released between 1s-5s)...");
                window.location.href = 'main_menu.html';
            } else if (currentLongPressDuration < SHOW_OVERLAY_DURATION) {
                console.log("Long press cancelled (too short).");
            }
            currentLongPressDuration = 0;
            longPressThresholdMet = false;
        }


        // --- Initialization ---
        window.addEventListener('load', () => {
            // --- DOM Element Selection (Moved inside 'load') ---
            mainContent = document.getElementById('main-content');
            statusPrompt = document.getElementById('status-prompt');
            ratioSettingDisplay = document.getElementById('ratio-setting-display');
            ratioValueEditable = document.getElementById('ratio-value-editable');
            primaryDisplayContainer = document.getElementById('primary-display-container');
            primaryDisplay = document.getElementById('primary-display');
            primaryValue = document.getElementById('primary-value');
            primaryUnit = document.getElementById('primary-unit');
            secondaryDisplay = document.getElementById('secondary-display');
            ratioLabel = document.getElementById('ratio-label');
            ratioValue = document.getElementById('ratio-value');
            ratioUnit = document.getElementById('ratio-unit'); // 添加这行
            timerValue = document.getElementById('timer-value');
            bottomLeftLabel = document.getElementById('bottom-left-label');
            bottomLeftValue = document.getElementById('bottom-left-value');
            bottomLeftUnit = document.getElementById('bottom-left-unit');
            bottomRightLabel = document.getElementById('bottom-right-label');
            bottomRightValue = document.getElementById('bottom-right-value');
            bottomRightUnit = bottomRightValue.nextElementSibling;
            hintBarContainer = document.getElementById('hint-progress-bar-container');
            hintText = document.getElementById('hint-text');
            progressBarFill = document.getElementById('progress-bar-fill');
            tareIndicator = document.getElementById('tare-indicator');
            ratioInfoItem = ratioValue.closest('.info-item');
            timeInfoItem = timerValue.closest('.info-item');
            bottomLeftInfoItem = bottomLeftValue.closest('.info-item');
            bottomRightInfoItem = bottomRightValue.closest('.info-item');
            longPressOverlay = document.getElementById('long-press-overlay');
            progressCircle = document.getElementById('progress-circle');
            progressText = document.getElementById('progress-text');
            longPressActionText = document.getElementById('long-press-action-text');
            powerOffConfirmOverlay = document.getElementById('power-off-confirm-overlay');
            confirmCancelBtn = document.getElementById('confirm-cancel');
            confirmPowerOffBtn = document.getElementById('confirm-power-off');

            // Interaction Buttons
            btnRotateLeft = document.getElementById('btn-rotate-left');
            btnRotateRight = document.getElementById('btn-rotate-right');
            btnShortPress = document.getElementById('btn-short-press');
            btnLongPress = document.getElementById('btn-long-press');
            btnReturnIndex = document.getElementById('btn-return-index');
            btnSimulatePlace = document.getElementById('btn-simulate-place');
            btnSimulateRemove = document.getElementById('btn-simulate-remove');

            // --- Event Listeners (Moved inside 'load') ---
            btnRotateLeft.addEventListener('click', () => handleRotate(-1));
            btnRotateRight.addEventListener('click', () => handleRotate(1));
            btnShortPress.addEventListener('click', handleShortPress);
            btnLongPress.addEventListener('mousedown', startLongPress);
            btnLongPress.addEventListener('mouseup', cancelLongPress);
            btnLongPress.addEventListener('mouseleave', cancelLongPress);
            btnReturnIndex.addEventListener('click', () => { window.location.href = 'index.html'; });
            btnSimulatePlace.addEventListener('click', () => {
                 let weightToAdd = 0;
                if (currentState === State.WAITING_GEAR_TARE) weightToAdd = 170.2 + 303.3; // Use correct variable name
                else if (currentState === State.WAITING_GROUNDS) weightToAdd = 15.7; // Use correct variable name
                else if (currentState === State.READY_TO_POUR) weightToAdd = 0.5;
                else if (currentState === State.POURING) { startPourSimulation(true); return; }
                else return;
                simulatePlacement(weightToAdd);
            });
            btnSimulateRemove.addEventListener('click', simulateRemoval);

            // --- Initial Setup ---
            setState(State.SETTING_RATIO); // Start in ratio setting state
            if(progressCircle) { // Check if element exists before accessing style
                progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
                progressCircle.style.strokeDashoffset = circumference;
            }
            if(ratioValueEditable) ratioValueEditable.textContent = targetRatio; // Initialize ratio display
        });

        // 添加颜色插值函数
        function interpolateColor(color1, color2, factor) {
            if (factor <= 0) return color1;
            if (factor >= 1) return color2;
            
            // 将颜色转换为RGB
            const r1 = parseInt(color1.substring(1, 3), 16);
            const g1 = parseInt(color1.substring(3, 5), 16);
            const b1 = parseInt(color1.substring(5, 7), 16);
            
            const r2 = parseInt(color2.substring(1, 3), 16);
            const g2 = parseInt(color2.substring(3, 5), 16);
            const b2 = parseInt(color2.substring(5, 7), 16);
            
            // 计算插值
            const r = Math.round(r1 + (r2 - r1) * factor);
            const g = Math.round(g1 + (g2 - g1) * factor);
            const b = Math.round(b1 + (b2 - b1) * factor);
            
            // 转换回十六进制
            return `#${(r < 16 ? '0' : '') + r.toString(16)}${(g < 16 ? '0' : '') + g.toString(16)}${(b < 16 ? '0' : '') + b.toString(16)}`;
        }

    </script>

</body>
</html>
