<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手冲模式 2 - 智能食物秤 Pro</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding-bottom: 80px; }
        .device-screen { width: 100%; max-width: 480px; aspect-ratio: 4 / 3; background-color: #1a1a1a; color: #e0e0e0; border-radius: 0.5rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* Status Bar */
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background-color: rgba(0, 0, 0, 0.2); flex-shrink: 0; height: 36px; position: relative; }
        .status-bar > i { font-size: 18px; color: #e0e0e0; line-height: 1; flex-shrink: 0; }
        .status-bar > span#status-prompt { flex-grow: 1; text-align: center; font-size: 15px; color: #a0a0a0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0 5px; }

        /* Main Content Area */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 15px; position: relative; width: 100%; }
        .main-content.align-end { justify-content: flex-end; padding-bottom: 30px; }
        .ratio-setting-display { display: flex; align-items: baseline; justify-content: center; width: 100%; }
        .ratio-prefix { font-size: 60px; font-weight: 500; color: #a0a0a0; margin-right: 10px;}
        .ratio-value-editable { font-size: 100px; font-weight: 700; color: #ffffff; border: none; background: none; min-width: 100px; text-align: center; outline: none; padding: 0 5px; border-bottom: 2px solid #007AFF; line-height: 1; }
        .primary-display-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; flex: 1; margin: 0; }
        .primary-display { width: 100%; text-align: center; display: flex; justify-content: center; align-items: baseline; }
        .primary-value { font-size: 110px; font-weight: 700; line-height: 1; color: #ffffff; margin-right: 8px; }
        .primary-unit { font-size: 45px; font-weight: 500; color: #a0a0a0; text-align: left; transition: color 0.3s ease; }
        .main-content:not(.with-secondary) .primary-value { font-size: 110px; }
        .main-content:not(.with-secondary) .primary-unit { font-size: 45px; display: block; margin-top: 8px; }
        .main-content.with-secondary .primary-value { font-size: 72px; }
        .main-content.with-secondary .primary-unit { font-size: 28px; display: inline-block; margin-top: 0; }
        .unit-g { color: #60a5fa; } .unit-ml { color: #34d399; } .unit-oz { color: #fbbf24; } .unit-lb { color: #f87171; } .unit-lb-oz { color: #c084fc; }
        .secondary-display { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 400px; padding: 0 10px; margin-bottom: 15px; margin-top: -1px; }
        .info-item { display: flex; flex-direction: column; align-items: center; padding: 8px 8px; border-radius: 8px; transition: background-color 0.3s ease; min-height: 70px; }
        .info-item.bg-ratio { background-color: rgba(52, 152, 219, 0.3) !important; } 
        .info-item.bg-time { background-color: rgba(241, 196, 15, 0.3) !important; } 
        .info-item.bg-flow { background-color: rgba(230, 126, 34, 0.3) !important; } 
        .info-item.bg-grounds { background-color: rgba(155, 89, 182, 0.3) !important; } 
        .info-item.bg-liquid { background-color: rgba(52, 152, 219, 0.3) !important; } 
        .info-item.bg-removed { background-color: rgba(192, 57, 43, 0.3) !important; } 
        .info-item.bg-total-water { background-color: rgba(46, 204, 113, 0.3) !important; } 
        .info-label { font-size: 14px; color: rgba(255, 255, 255, 0.9); margin-bottom: 2px; font-weight: 500; }
        .info-value { font-size: 24px; font-weight: 600; color: #ffffff; line-height: 1.2; }
        .info-unit { font-size: 14px; color: rgba(255, 255, 255, 0.9); margin-left: 4px; font-weight: 500; }
        .tare-indicator { position: absolute; top: 20px; left: 15px; background-color: #007AFF; color: white; padding: 3px 8px; border-radius: 5px; font-size: 14px; font-weight: bold; opacity: 0; pointer-events: none; transition: opacity 0.2s ease-out; z-index: 999; display: block !important; white-space: nowrap; }
        .tare-indicator.visible { opacity: 1; }
        .hidden { display: none !important; }
        .ratio-display { transition: color 0.3s ease; }
        .ratio-display.ratio-white { color: #ffffff; }
        .ratio-display.ratio-green { color: #2ecc71; }
        .ratio-display.ratio-orange { color: #e67e22; }
        .ratio-display.ratio-red { color: #e74c3c; }

        /* New Hint Bar Styles */
        .hint-bar { 
            text-align: center; 
            padding: 0 10px; 
            background-color: rgba(0, 0, 0, 0.3); 
            font-size: 15px; 
            color: #b0b0b0; 
            flex-shrink: 0; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            white-space: normal; 
            overflow: hidden; 
            text-overflow: ellipsis;
            opacity: 1; 
            line-height: normal; 
        }
        .hint-bar.long-press-active { color: #ffffff; }
        @keyframes blink-text-animation { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .blink-text-inline { animation: blink-text-animation 1s infinite; font-weight: bold; }

        /* Interaction Controls Styles */
        .interaction-controls { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(240, 240, 240, 0.95); backdrop-filter: blur(5px); padding: 0.75rem 1rem; border-top: 1px solid #ccc; display: flex; justify-content: center; align-items: center; gap: 0.5rem; z-index: 100; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        .control-button { padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 500; background-color: #4f46e5; color: white; border: none; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .control-button:hover { background-color: #4338ca; }
        .control-button:active { transform: scale(0.95); }
        .control-button.secondary { background-color: #64748b; }
        .control-button.secondary:hover { background-color: #475569; }
        .control-button:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
    </style>
</head>
<body>

    <div class="device-screen">
        <div class="status-bar">
            <i class="fa-brands fa-bluetooth-b"></i>
            <span id="status-prompt"></span>
            <i class="fa-solid fa-battery-full"></i>
        </div>

        <div id="main-content" class="main-content">
            <div id="tare-indicator" class="tare-indicator">TARE</div>
            <div id="ratio-setting-display" class="ratio-setting-display">
                <span class="ratio-prefix">1 :</span>
                <span id="ratio-value-editable" class="ratio-value-editable">15</span>
            </div>
            <div id="primary-display-container" class="primary-display-container hidden">
                <div id="primary-display" class="primary-display">
                    <span id="primary-value" class="primary-value"></span>
                    <span id="primary-unit" class="primary-unit"></span>
                </div>
            </div>
            <div id="secondary-display" class="secondary-display hidden">
                <div class="info-item bg-total-water"> <span class="info-label" id="total-water-label">总注水</span> <span class="info-value"> <span id="total-water-value">0.0</span> <span class="info-unit" id="total-water-unit">g</span> </span> </div>
                <div class="info-item bg-time"> <span class="info-label">时间</span> <span id="timer-value" class="info-value">00:00</span> </div>
                <div class="info-item bg-flow"> <span class="info-label" id="flow-rate-label">流速</span> <span class="info-value"> <span id="flow-rate-value">0.0</span> <span class="info-unit" id="flow-rate-unit">g/s</span> </span> </div>
                <div class="info-item bg-grounds"> <span class="info-label" id="grounds-weight-label">粉重</span> <span class="info-value"> <span id="grounds-weight-value">0.0</span> <span class="info-unit" id="grounds-weight-unit">g</span> </span> </div>
            </div>
        </div>
        <div id="hint-bar" class="hint-bar"></div>
    </div>

    <div class="interaction-controls">
        <button id="btn-rotate-left" class="control-button" title="模拟向左旋转">← 旋转</button>
        <button id="btn-rotate-right" class="control-button" title="模拟向右旋转">旋转 →</button>
        <button id="btn-short-press" class="control-button" title="模拟短按">确认比例</button>
        <button id="btn-long-press" class="control-button secondary" title="模拟长按旋钮">长按 (返回/关机)</button>
        <button id="btn-return-index" class="control-button secondary" title="返回目录页面">返回目录</button>
        <button id="btn-simulate-place" class="control-button" style="background-color: #10b981;" disabled>模拟放置</button>
        <button id="btn-simulate-remove" class="control-button" style="background-color: #f87171;" disabled>模拟拿走</button>
    </div>

    <script>
        // --- DOM Elements ---
        let mainContent, statusPrompt, ratioSettingDisplay, ratioValueEditable,
            primaryDisplayContainer, primaryDisplay, primaryValue, primaryUnit,
            secondaryDisplay, totalWaterLabel, totalWaterValue, totalWaterUnit, timerValue,
            flowRateLabel, flowRateValue, flowRateUnit,
            groundsWeightLabel, groundsWeightValue, groundsWeightUnit,
            hintBar, tareIndicator,
            totalWaterInfoItem, timeInfoItem, flowRateInfoItem, groundsWeightInfoItem,
            btnRotateLeft, btnRotateRight, btnShortPress, btnLongPress,
            btnReturnIndex, btnSimulatePlace, btnSimulateRemove;
            // btnToggleLanguage removed
        
        // --- State Variables ---
        const State = { 
            SETTING_RATIO: 'SETTING_RATIO', 
            WAITING_CARAFE: 'WAITING_CARAFE',  // 等待放置量杯状态
            WAITING_GEAR_TARE: 'WAITING_GEAR_TARE', 
            WAITING_GROUNDS: 'WAITING_GROUNDS', 
            WEIGHING_GROUNDS: 'WEIGHING_GROUNDS', 
            READY_TO_POUR: 'READY_TO_POUR', 
            POURING: 'POURING', 
            FINISHED: 'FINISHED', 
            WEIGHING_LIQUID: 'WEIGHING_LIQUID' 
        };
        let currentState = State.SETTING_RATIO;
        let targetRatio = 15; 
        let currentWeight = 0.0; 
        let carafeWeight = 0.0;  // 新增量杯重量变量
        let gearWeight = 0.0;
        let coffeeGroundsWeight = 15.7; let measuredGroundsWeight = 0.0;
        let totalWaterWeight = 0.0; let coffeeLiquidWeight = 0.0; let removedWeight = 0.0;
        let timerInterval = null; let timerSeconds = 0; let pouringInterval = null;
        let lastWaterAddTime = 0; let lastWaterWeight = 0; let currentFlowRateGramsPerSecond = 0.0;
        let calculatedTargetWaterWeight = 0.0;

        // New long press state variables
        let longPressTimer = null; 
        let longPressStartTime = 0;
        let currentLongPressDuration = 0; 
        let longPressActive = false; 
        const LONG_PRESS_RETURN_DURATION = 1000; 
        const LONG_PRESS_POWER_OFF_DURATION = 5000; 
        const LONG_PRESS_ACTION_NONE = 0;
        const LONG_PRESS_ACTION_RETURN = 1;
        const LONG_PRESS_ACTION_POWER_OFF = 2;
        let currentLongPressAction = LONG_PRESS_ACTION_NONE;

        const units = ['g', 'ml', 'fl:oz', 'oz', 'lb'];
        const unitColors = { 'g': 'unit-g', 'ml': 'unit-ml', 'fl:oz': 'unit-oz', 'oz': 'unit-oz', 'lb': 'unit-lb' };
        let currentUnitIndex = 0; let tareTimeout = null;
        const G_PER_ML = 1.0; const G_PER_OZ = 28.3495; const G_PER_LB = 453.592; const ML_PER_FL_OZ = 29.5735;

        // --- Functions ---
        function formatTime(seconds) { const mins = Math.floor(seconds / 60); const secs = seconds % 60; return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; }
        function startTimer() { if (timerInterval) return; timerSeconds = 0; lastWaterAddTime = Date.now(); lastWaterWeight = 0.0; currentFlowRateGramsPerSecond = 0.0; timerValue.textContent = formatTime(timerSeconds); timerInterval = setInterval(() => { timerSeconds++; if (timerSeconds >= 600) { stopTimer(); timerSeconds = 599; } timerValue.textContent = formatTime(timerSeconds); if (currentState === State.POURING && !pouringInterval) { calculateFlowRate(0); } }, 1000); }
        function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } if (pouringInterval) { clearInterval(pouringInterval); pouringInterval = null; } currentFlowRateGramsPerSecond = 0.0; }
        function resetScale() { stopTimer(); timerSeconds = 0; currentWeight = 0.0; gearWeight = 0.0; measuredGroundsWeight = 0.0; coffeeGroundsWeight = 15.7; totalWaterWeight = 0.0; coffeeLiquidWeight = 0.0; removedWeight = 0.0; currentUnitIndex = 0; currentFlowRateGramsPerSecond = 0.0; targetRatio = 15; calculatedTargetWaterWeight = 0.0; setState(State.SETTING_RATIO); }
        function getDecimalPlaces(weight, unit) { if (unit === 'g' || unit === 'ml') { if (weight < 500) return 1; if (weight <= 1000) return 0; if (weight <= 2000) return 0; if (weight <= 3000) return 0; if (weight <= 4000) return 0; return 0; } else if (unit === 'oz') { if (weight < 17.64) return 2; if (weight < 35.27) return 1; return 0; } else if (unit === 'fl:oz') { if (weight < 16.91) return 2; if (weight < 33.81) return 1; return 0; } else if (unit === 'lb') { if (weight < 1.1) return 3; if (weight < 2.2) return 2; if (weight < 4.4) return 2; return 1; } return 1; }
        function formatWeight(weightValue) { const currentUnit = units[currentUnitIndex]; let valueInGrams = weightValue; let displayUnit = 'g'; let valueToDisplay = valueInGrams; if (currentUnit === 'ml') { valueToDisplay = valueInGrams / G_PER_ML; displayUnit = 'ml'; } else if (currentUnit === 'oz') { valueToDisplay = valueInGrams / G_PER_OZ; displayUnit = 'oz'; } else if (currentUnit === 'fl:oz') { valueToDisplay = valueInGrams / ML_PER_FL_OZ; displayUnit = 'fl:oz'; } else if (currentUnit === 'lb') { valueToDisplay = valueInGrams / G_PER_LB; displayUnit = 'lb'; } const decimalPlaces = getDecimalPlaces(valueToDisplay, currentUnit); let displayWeight; if (Math.abs(valueToDisplay) < 0.3 && (currentUnit === 'g' || currentUnit === 'ml')) { displayWeight = '0.0'; } else { displayWeight = valueToDisplay.toFixed(decimalPlaces); } return { value: displayWeight, unit: displayUnit }; }
        function formatFlowRate(rateGramsPerSecond) { const currentUnit = units[currentUnitIndex]; let displayRate; let displayUnitSuffix = '/s'; if (currentUnit === 'ml') { displayRate = (rateGramsPerSecond / G_PER_ML).toFixed(1); displayUnitSuffix = 'ml/s'; } else if (currentUnit === 'oz' || currentUnit === 'fl:oz') { displayRate = (rateGramsPerSecond / G_PER_OZ).toFixed(1); displayUnitSuffix = 'oz/s'; } else if (currentUnit === 'lb') { displayRate = (rateGramsPerSecond / G_PER_LB).toFixed(2); displayUnitSuffix = 'lb/s'; } else { displayRate = rateGramsPerSecond.toFixed(1); displayUnitSuffix = 'g/s'; } if (Math.abs(parseFloat(displayRate)) < 0.01) { displayRate = (0.0).toFixed(displayRate.includes('.') ? displayRate.split('.')[1].length : 1); } return { value: displayRate, unit: displayUnitSuffix }; }
        function showTareIndicator() { if (!tareIndicator) return; tareIndicator.classList.add('visible'); if (tareTimeout) { clearTimeout(tareTimeout); } tareTimeout = setTimeout(() => { tareIndicator.classList.remove('visible'); tareTimeout = null; }, 1000); }
        function calculateFlowRate(addedWaterGrams) { const now = Date.now(); const timeDiff = (now - lastWaterAddTime) / 1000; if (timeDiff > 0.1) { currentFlowRateGramsPerSecond = addedWaterGrams / timeDiff; lastWaterAddTime = now; lastWaterWeight = totalWaterWeight; } else if (addedWaterGrams === 0 && timeDiff > 0.5) { currentFlowRateGramsPerSecond = 0.0; } if (secondaryDisplay && !secondaryDisplay.classList.contains('hidden') && flowRateValue && flowRateUnit) { flowRateValue.textContent = formatFlowRate(currentFlowRateGramsPerSecond).value; flowRateUnit.textContent = formatFlowRate(currentFlowRateGramsPerSecond).unit; } }

        function updateUI() {
            if (!mainContent || !statusPrompt || !ratioSettingDisplay || !primaryDisplayContainer || !hintBar) { console.error("DOM elements not ready for updateUI"); return; }
            const currentUnit = units[currentUnitIndex]; 
            let promptText = ''; 
            let hintTextVal = ''; 
            let shortPressAction = '';
            let showRatioSetting = false; 
            let showWeightPrimaryLarge = false; 
            let showWaterPrimary = false; 
            let showLiquidPrimary = false;
            let showSecondary = false; 
            let enableRotation = false; 
            let shortPressEnabled = true; 
            let centerContentVertically = true;

            switch (currentState) {
                case State.SETTING_RATIO: 
                    showRatioSetting = true; 
                    enableRotation = true; 
                    centerContentVertically = true; 
                    promptText = "请设置粉和水的比例"; 
                    hintTextVal = "旋转调整｜短按确认"; 
                    shortPressAction = '确认比例'; 
                    break;
                case State.WAITING_CARAFE: 
                    showWeightPrimaryLarge = true; 
                    enableRotation = true; 
                    centerContentVertically = false; 
                    promptText = "请放上咖啡量杯壶"; 
                    hintTextVal = "旋转切换单位"; 
                    shortPressAction = 'TARE'; 
                    break;
                case State.WAITING_GEAR_TARE: 
                    showWeightPrimaryLarge = true; 
                    enableRotation = true; 
                    centerContentVertically = false; 
                    if (currentWeight > 10) {
                        promptText = "等待去皮...."; 
                        hintTextVal = "旋转切换单位｜短按去皮"; 
                    } else {
                        promptText = "请放上滤杯与滤纸"; 
                        hintTextVal = "旋转切换单位"; 
                    }
                    shortPressAction = 'TARE'; 
                    break;
                case State.WAITING_GROUNDS: 
                    showWeightPrimaryLarge = true; 
                    enableRotation = true; 
                    centerContentVertically = false; 
                    promptText = "接下来，请加入咖啡粉"; 
                    hintTextVal = "旋转切换单位"; 
                    shortPressAction = 'TARE'; 
                    break;
                case State.WEIGHING_GROUNDS: 
                    showWeightPrimaryLarge = true; 
                    enableRotation = true; 
                    centerContentVertically = false; 
                    promptText = "等待去皮...."; 
                    hintTextVal = "旋转切换单位｜短按去皮"; 
                    shortPressAction = 'TARE'; 
                    break;
                case State.READY_TO_POUR: 
                    promptText = "等待注水..."; 
                    showWaterPrimary = true; 
                    showSecondary = true; 
                    enableRotation = false; 
                    centerContentVertically = true; 
                    shortPressAction = '---'; 
                    hintTextVal = "准备就绪，可以开始注水"; 
                    break;
                case State.POURING: 
                    promptText = "注水中..."; 
                    shortPressAction = '停止'; 
                    showWaterPrimary = true; 
                    showSecondary = true; 
                    enableRotation = false; 
                    centerContentVertically = true; 
                    hintTextVal = "短按停止计时"; 
                    break;
                case State.FINISHED: 
                    promptText = "冲煮完成"; 
                    hintTextVal = "短按复位 | 移除滤杯看粉液比"; 
                    shortPressAction = '复位'; 
                    showWaterPrimary = true; 
                    showSecondary = true; 
                    enableRotation = false; 
                    centerContentVertically = true; 
                    break;
                case State.WEIGHING_LIQUID: 
                    showLiquidPrimary = true; 
                    showSecondary = true; 
                    enableRotation = false; 
                    centerContentVertically = true; 
                    promptText = "计算液重"; 
                    hintTextVal = "短按复位"; 
                    shortPressAction = '复位'; 
                    break;
            }
            mainContent.classList.toggle('center-content', centerContentVertically); mainContent.classList.toggle('align-end', !centerContentVertically);
            ratioSettingDisplay.classList.toggle('hidden', !showRatioSetting); primaryDisplayContainer.classList.toggle('hidden', showRatioSetting);
            secondaryDisplay.classList.toggle('hidden', !showSecondary);
            mainContent.classList.toggle('with-secondary', showSecondary && !showRatioSetting);

            if (!showRatioSetting) {
                if (showWeightPrimaryLarge) { const formatted = formatWeight(currentWeight); primaryValue.textContent = formatted.value; primaryUnit.textContent = formatted.unit; primaryValue.className = 'primary-value'; primaryUnit.className = 'primary-unit'; if (unitColors[formatted.unit]) { primaryUnit.classList.add(unitColors[formatted.unit]); } } 
                else if (showWaterPrimary) { const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight; const currentRatio = grounds > 0 ? totalWaterWeight / grounds : 0; primaryValue.textContent = '1:' + currentRatio.toFixed(1); primaryUnit.textContent = ''; primaryValue.className = 'primary-value ratio-display'; const targetPercent = (currentRatio / targetRatio) * 100; primaryValue.classList.remove('ratio-white', 'ratio-green', 'ratio-orange', 'ratio-red'); if (targetPercent === 0) { primaryValue.classList.add('ratio-white'); } else if (targetPercent <= 60) { primaryValue.classList.add('ratio-green'); } else if (targetPercent <= 80) { primaryValue.classList.add('ratio-orange'); } else { primaryValue.classList.add('ratio-red'); } } 
                else if (showLiquidPrimary) { const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight; const liquidRatio = grounds > 0 ? coffeeLiquidWeight / grounds : 0; primaryValue.textContent = '1:' + liquidRatio.toFixed(1); primaryUnit.textContent = ''; primaryValue.className = 'primary-value ratio-display ratio-white'; }
            }
            if (showSecondary) {
                const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight;
                const totalWaterFormatted = formatWeight(totalWaterWeight); const liquidFormatted = formatWeight(coffeeLiquidWeight); const removedFormatted = formatWeight(removedWeight); const flowRateFormatted = formatFlowRate(currentFlowRateGramsPerSecond);
                totalWaterInfoItem.className = 'info-item'; timeInfoItem.className = 'info-item bg-time'; flowRateInfoItem.className = 'info-item'; groundsWeightInfoItem.className = 'info-item';
                if (grounds > 0.1) {
                    if (currentState === State.POURING || currentState === State.READY_TO_POUR || currentState === State.FINISHED) {
                        totalWaterLabel.textContent = "总注水"; totalWaterValue.textContent = totalWaterFormatted.value; totalWaterUnit.textContent = totalWaterFormatted.unit;
                        timerValue.textContent = formatTime(timerSeconds);
                        flowRateLabel.textContent = "流速"; flowRateValue.textContent = flowRateFormatted.value; flowRateUnit.textContent = flowRateFormatted.unit;
                        groundsWeightLabel.textContent = "粉重"; groundsWeightValue.textContent = grounds.toFixed(1); groundsWeightUnit.textContent = 'g';
                        totalWaterInfoItem.classList.add('bg-total-water'); flowRateInfoItem.classList.add('bg-flow'); groundsWeightInfoItem.classList.add('bg-grounds');
                    } else { // WEIGHING_LIQUID
                        totalWaterLabel.textContent = "总注水"; totalWaterValue.textContent = totalWaterFormatted.value; totalWaterUnit.textContent = totalWaterFormatted.unit;
                        timerValue.textContent = formatTime(timerSeconds);
                        flowRateLabel.textContent = "移走重量"; flowRateValue.textContent = removedFormatted.value; flowRateUnit.textContent = removedFormatted.unit;
                        groundsWeightLabel.textContent = "液重"; groundsWeightValue.textContent = liquidFormatted.value; groundsWeightUnit.textContent = liquidFormatted.unit;
                        totalWaterInfoItem.classList.add('bg-total-water'); flowRateInfoItem.className = 'info-item bg-removed'; groundsWeightInfoItem.className = 'info-item bg-liquid';
                    }
                } else {
                    totalWaterLabel.textContent = "总注水"; totalWaterValue.textContent = '0.0'; totalWaterUnit.textContent = 'g';
                    timerValue.textContent = formatTime(timerSeconds);
                    flowRateLabel.textContent = "流速"; flowRateValue.textContent = '0.0'; flowRateUnit.textContent = "g/s";
                    groundsWeightLabel.textContent = "粉重"; groundsWeightValue.textContent = '0.0'; groundsWeightUnit.textContent = 'g';
                    totalWaterInfoItem.classList.add('bg-total-water'); flowRateInfoItem.classList.add('bg-flow'); groundsWeightInfoItem.classList.add('bg-grounds');
                }
            }
            statusPrompt.textContent = promptText; 
            
            if (!longPressActive && hintBar) {
                if (currentState === State.POURING) {
                    const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight;
                    calculatedTargetWaterWeight = grounds * targetRatio;
                    let progressPercent = 0;
                    if (calculatedTargetWaterWeight > 0.01) {
                        progressPercent = Math.min(100, (totalWaterWeight / calculatedTargetWaterWeight) * 100);
                    }
                    hintTextVal = `短按停止计时 (${progressPercent.toFixed(0)}%)`;
                }
                // For other states, hintTextVal is already set in the switch or will use the default from cancelLongPress
                hintBar.textContent = hintTextVal;
            }

            btnShortPress.textContent = `${shortPressAction === '---' ? '---' : shortPressAction} (短按)`; btnShortPress.disabled = !shortPressEnabled;
            btnRotateLeft.disabled = !enableRotation; btnRotateRight.disabled = !enableRotation;
            btnSimulatePlace.disabled = currentState === State.SETTING_RATIO || currentState === State.FINISHED || currentState === State.WEIGHING_LIQUID;
            btnSimulateRemove.disabled = currentState !== State.FINISHED;
        }
        function setState(newState) { console.log(`State transition: ${currentState} -> ${newState}`); currentState = newState; if (mainContent) { updateUI(); } else { console.warn("setState called before DOM ready."); } }
        function simulatePlacement(weight) { 
            if (longPressActive) return; 
            console.log(`Simulating placement: ${weight}g`); 
            if (currentState === State.SETTING_RATIO) return; 
            currentWeight += weight; 
            switch (currentState) { 
                case State.WAITING_CARAFE: 
                    if (currentWeight > 10) {
                        carafeWeight = currentWeight;
                        console.log(`Carafe detected (${carafeWeight.toFixed(1)}g), auto-taring.`);
                        setTimeout(() => {
                            showTareIndicator();
                            currentWeight = 0.0;
                            setState(State.WAITING_GEAR_TARE);
                        }, 500);
                    }
                    break;
                case State.WAITING_GEAR_TARE: 
                    if (currentWeight > 10) {
                        console.log(`Gear detected (${currentWeight.toFixed(1)}g), waiting for tare.`);
                        updateUI();
                    }
                    break; 
                case State.WAITING_GROUNDS: 
                    if (currentWeight > 0.5) { 
                        measuredGroundsWeight = currentWeight; 
                        console.log(`Grounds added: ${measuredGroundsWeight.toFixed(1)}g. Waiting manual tare.`); 
                        setState(State.WEIGHING_GROUNDS); 
                    } 
                    break; 
                case State.READY_TO_POUR: if (weight > 0.1) { console.log("Water detected, starting timer and pour..."); startTimer(); startPourSimulation(); setState(State.POURING); } break; 
                case State.POURING: console.log("Adding more water during pour..."); startPourSimulation(true); break; 
            } 
            updateUI(); 
        }
        function startPourSimulation(isContinuing = false) { 
            console.log(`startPourSimulation called. isContinuing: ${isContinuing}, pouringInterval: ${pouringInterval}`);
            if (pouringInterval && !isContinuing) { console.log("Pouring already in progress and not continuing, returning."); return; } 
            if (!isContinuing) { 
                console.log("Starting new pour simulation.");
                lastWaterWeight = 0.0; 
                lastWaterAddTime = Date.now(); 
                if (totalWaterWeight === 0) currentWeight = 0; 
            } else {
                console.log("Continuing pour simulation.");
            }
            const pourRate = 4.0; 
            const intervalTime = 200;
            if (pouringInterval) { console.log("Clearing existing pouringInterval."); clearInterval(pouringInterval); } 
            pouringInterval = setInterval(() => { 
                const waterToAdd = pourRate; 
                totalWaterWeight += waterToAdd; 
                currentWeight = totalWaterWeight; 
                console.log(`Pouring interval: totalWaterWeight=${totalWaterWeight.toFixed(1)}, currentWeight=${currentWeight.toFixed(1)}`);
                calculateFlowRate(waterToAdd); 
                const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight;
                calculatedTargetWaterWeight = grounds * targetRatio; 
                if (totalWaterWeight >= calculatedTargetWaterWeight) { 
                    totalWaterWeight = calculatedTargetWaterWeight; 
                    currentWeight = totalWaterWeight; 
                    stopPourSimulation(); 
                    console.log("Target water weight reached."); 
                } 
                updateUI(); 
            }, intervalTime);
            console.log("pouringInterval set:", pouringInterval);
        }
        function stopPourSimulation() { if (pouringInterval) { console.log("Stopping pour simulation."); clearInterval(pouringInterval); pouringInterval = null; calculateFlowRate(0); updateUI(); } }
        function simulateRemoval() { if (longPressActive) return; console.log("Simulating removal"); if (currentState === State.FINISHED || currentState === State.WEIGHING_LIQUID) { stopPourSimulation(); stopTimer(); const grounds = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight; const retainedWater = grounds * 2; coffeeLiquidWeight = Math.max(0, totalWaterWeight - retainedWater); removedWeight = gearWeight + grounds + retainedWater; console.log(`Filter removed. Liquid: ${coffeeLiquidWeight.toFixed(1)}g, Retained: ${retainedWater.toFixed(1)}g, Removed: ${removedWeight.toFixed(1)}g`); setState(State.WEIGHING_LIQUID); } else { console.warn(`Cannot simulate removal in state: ${currentState}`); } }
        
        function handleShortPress() { 
            if (longPressActive) return; 
            console.log(`Short press in state: ${currentState}`); 
            switch (currentState) { 
                case State.SETTING_RATIO: 
                    setState(State.WAITING_CARAFE); 
                    break; 
                case State.WAITING_GEAR_TARE: 
                    if (currentWeight > 10) {
                        showTareIndicator(); 
                        gearWeight = currentWeight; 
                        currentWeight = 0.0; 
                        setState(State.WAITING_GROUNDS); 
                    }
                    break; 
                case State.WEIGHING_GROUNDS: showTareIndicator(); coffeeGroundsWeight = measuredGroundsWeight > 0.1 ? measuredGroundsWeight : coffeeGroundsWeight; currentWeight = 0.0; totalWaterWeight = 0.0; setState(State.READY_TO_POUR); break; 
                case State.POURING: stopTimer(); stopPourSimulation(); setState(State.FINISHED); break; 
                case State.WEIGHING_LIQUID: case State.FINISHED: resetScale(); break; 
            } 
        }
        function handleRotate(direction) { 
            if (longPressActive) return; 
            if (currentState === State.SETTING_RATIO) { targetRatio += direction; if (targetRatio < 1) targetRatio = 99; if (targetRatio > 99) targetRatio = 1; ratioValueEditable.textContent = targetRatio; } 
            else if (currentState === State.WAITING_GEAR_TARE || currentState === State.WEIGHING_GROUNDS) { currentUnitIndex = (currentUnitIndex + direction + units.length) % units.length; updateUI(); } 
        }

        // --- New Long Press Logic ---
        function simulateDirectPowerOff() { console.log("Simulating Direct Power Off - Black Screen"); disableAllButtons(); const deviceScreen = document.querySelector('.device-screen'); if (deviceScreen) { deviceScreen.innerHTML = ''; deviceScreen.style.backgroundColor = '#000000'; } if (longPressActive && longPressTimer) { cancelAnimationFrame(longPressTimer); longPressTimer = null; longPressActive = false; } }
        function disableAllButtons() { [btnRotateLeft, btnRotateRight, btnShortPress, btnLongPress, btnReturnIndex, btnSimulatePlace, btnSimulateRemove].forEach(btn => { if(btn) btn.disabled = true; }); } // Removed btnToggleLanguage
        function startLongPress() { if (longPressActive) return; longPressActive = true; longPressStartTime = Date.now(); currentLongPressDuration = 0; currentLongPressAction = LONG_PRESS_ACTION_NONE; if (hintBar) { hintBar.classList.add('long-press-active'); } updateLongPressHintText(); longPressTimer = requestAnimationFrame(updateLongPressHintLoop); }
        function updateLongPressHintLoop() { if (!longPressActive) return; updateLongPressHintText(); longPressTimer = requestAnimationFrame(updateLongPressHintLoop); }
        function updateLongPressHintText() { currentLongPressDuration = Date.now() - longPressStartTime; let remainingSecondsForPowerOff; if (currentLongPressDuration < LONG_PRESS_POWER_OFF_DURATION) { remainingSecondsForPowerOff = Math.ceil((LONG_PRESS_POWER_OFF_DURATION - currentLongPressDuration) / 1000); if (hintBar) { hintBar.innerHTML = `长按<span class="blink-text-inline">${remainingSecondsForPowerOff}s</span>后将关机，现在松开旋钮返回上一级菜单`; } currentLongPressAction = (currentLongPressDuration < LONG_PRESS_RETURN_DURATION) ? LONG_PRESS_ACTION_NONE : LONG_PRESS_ACTION_RETURN; } else { if (longPressActive) { simulateDirectPowerOff(); } return; } }
        function cancelLongPress() {
            if (!longPressActive) return; longPressActive = false; if (longPressTimer) { cancelAnimationFrame(longPressTimer); longPressTimer = null; }
            if (hintBar) {
                hintBar.classList.remove('long-press-active');
                // updateUI will set the correct hint text based on current state
            }
            // updateUI will also restore statusPrompt
            updateUI(); // Call updateUI to restore normal hint and status texts

            if (currentLongPressAction === LONG_PRESS_ACTION_RETURN) { console.log("Executing Back Action..."); window.location.href = 'coffee_scale_menu.html'; } 
            else if (currentLongPressAction === LONG_PRESS_ACTION_NONE) { console.log("Long press cancelled (不足1秒)."); }
            currentLongPressDuration = 0; currentLongPressAction = LONG_PRESS_ACTION_NONE;
        }
        // --- End New Long Press Logic ---

        // --- Initialization ---
        window.addEventListener('load', () => {
            mainContent = document.getElementById('main-content');
            statusPrompt = document.getElementById('status-prompt');
            ratioSettingDisplay = document.getElementById('ratio-setting-display');
            ratioValueEditable = document.getElementById('ratio-value-editable');
            primaryDisplayContainer = document.getElementById('primary-display-container');
            primaryDisplay = document.getElementById('primary-display');
            primaryValue = document.getElementById('primary-value');
            primaryUnit = document.getElementById('primary-unit');
            secondaryDisplay = document.getElementById('secondary-display');
            totalWaterLabel = document.getElementById('total-water-label');
            totalWaterValue = document.getElementById('total-water-value');
            totalWaterUnit = document.getElementById('total-water-unit');
            timerValue = document.getElementById('timer-value');
            flowRateLabel = document.getElementById('flow-rate-label');
            flowRateValue = document.getElementById('flow-rate-value');
            flowRateUnit = document.getElementById('flow-rate-unit');
            groundsWeightLabel = document.getElementById('grounds-weight-label');
            groundsWeightValue = document.getElementById('grounds-weight-value');
            groundsWeightUnit = document.getElementById('grounds-weight-unit');
            hintBar = document.getElementById('hint-bar'); 
            tareIndicator = document.getElementById('tare-indicator');
            totalWaterInfoItem = totalWaterValue.closest('.info-item');
            timeInfoItem = timerValue.closest('.info-item');
            flowRateInfoItem = flowRateValue.closest('.info-item');
            groundsWeightInfoItem = groundsWeightValue.closest('.info-item');
            
            btnRotateLeft = document.getElementById('btn-rotate-left');
            btnRotateRight = document.getElementById('btn-rotate-right');
            btnShortPress = document.getElementById('btn-short-press');
            btnLongPress = document.getElementById('btn-long-press');
            btnReturnIndex = document.getElementById('btn-return-index');
            btnSimulatePlace = document.getElementById('btn-simulate-place');
            btnSimulateRemove = document.getElementById('btn-simulate-remove');
            // btnToggleLanguage removed

            btnRotateLeft.addEventListener('click', () => handleRotate(-1));
            btnRotateRight.addEventListener('click', () => handleRotate(1));
            btnShortPress.addEventListener('click', handleShortPress);
            btnLongPress.addEventListener('mousedown', startLongPress);
            btnLongPress.addEventListener('mouseup', cancelLongPress);
            btnLongPress.addEventListener('mouseleave', cancelLongPress);
            btnReturnIndex.addEventListener('click', () => { window.location.href = 'index.html'; });
            
            btnSimulatePlace.addEventListener('click', () => {
                if (longPressActive) return; 
                let weightToAdd = 0;
                if (currentState === State.WAITING_CARAFE) weightToAdd = 170.2;
                else if (currentState === State.WAITING_GEAR_TARE) weightToAdd = 303.3; 
                else if (currentState === State.WAITING_GROUNDS) weightToAdd = 15.7; 
                else if (currentState === State.READY_TO_POUR) weightToAdd = 0.5; 
                else if (currentState === State.POURING) { startPourSimulation(true); return; }
                else return;
                simulatePlacement(weightToAdd);
            });
            btnSimulateRemove.addEventListener('click', () => {
                if (longPressActive) return; 
                simulateRemoval();
            });

            // btnToggleLanguage event listener removed

            setState(State.SETTING_RATIO); 
            if(ratioValueEditable) ratioValueEditable.textContent = targetRatio;
        });
    </script>
</body>
</html>
